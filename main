/*
 * ════════════════════════════════════════════════════════════════════════════
 * FICHIER: main.c
 * Description: Programme principal (VERSION 100% GETCH - SANS SCANF)
 * ════════════════════════════════════════════════════════════════════════════
 */

#include <stdio.h>
#include <stdlib.h>
#include <conio.h>      // <-- Indispensable pour getch()
#include "structures.h"
#include "affichage.h"
#include "moteur.h"
#include "sauvegarde.h"

// Constantes pour la taille d'affichage (correspondant à affichage.c)
#define HAUTEUR_AFFICHEE 12
#define LARGEUR_AFFICHEE 20

// Déclaration de la fonction de la boucle de jeu
void jouerNiveau(Partie* partie);


int main() {
    Partie partie;
    int continuer = 1;

    // Configuration de la console
    system("chcp 65001 > nul");

    while (continuer) {
        afficherMenuPrincipal();

        // --- LA CORRECTION CLÉ EST ICI ---
        // On utilise getch() pour le menu.
        // Il ne nécessite pas [Entrée] et ne s'affiche pas à l'écran.
        char touche = getch();

        switch (touche) {
            case '1': // Afficher les règles
                afficherRegles();
                getch(); // Attendre une touche pour revenir
                break;

            case '2': // Commencer une nouvelle partie
                initialiserPartie(&partie);
                // On appelle SEULEMENT la boucle de jeu.
                jouerNiveau(&partie);
                break;

            case '3': // Charger une partie
                effacerEcran();
                afficherMessageTemporaire("Chargement non implémenté pour cette démo");
                getch();
                break;

            case '4': // Quitter
                continuer = 0;
                break;

            default: // Choix invalide
                allerA(0, 30); // Position en bas
                afficherMessageTemporaire("Choix invalide !");
                getch(); // Attend une touche pour continuer
                break;
        }
    }

    effacerEcran();
    changerCouleur(COULEUR_VERT);
    printf("\n\n    Merci d'avoir joué à ECE HEROES !\n\n");
    changerCouleur(COULEUR_RESET);

    return 0;
}


/*
 * ════════════════════════════════════════════════════════════════════════════
 * Boucle de jeu principale (Gère Flèches + ZQSD)
 * ════════════════════════════════════════════════════════════════════════════
 */
void jouerNiveau(Partie* partie) {
    int curseurX = 5;
    int curseurY = 5;

    int selectX = -1; // -1 = rien de sélectionné
    int selectY = -1;

    int partieEnCours = 1;
    unsigned char touche;

    // Affiche le niveau UNE SEULE FOIS (au début)
    afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);

    while (partieEnCours) {

        touche = getch(); // Lit la touche instantanément

        // --- GESTION DES FLÈCHES (Codes étendus 224) ---
        if (touche == 224) {
            touche = getch(); // Lit le deuxième code
            switch (touche) {
                case 72: // Flèche HAUT
                    if (curseurY > 0) curseurY--;
                    break;
                case 80: // Flèche BAS
                    if (curseurY < HAUTEUR_AFFICHEE - 1) curseurY++;
                    break;
                case 75: // Flèche GAUCHE
                    if (curseurX > 0) curseurX--;
                    break;
                case 77: // Flèche DROITE
                    if (curseurX < LARGEUR_AFFICHEE - 1) curseurX++;
                    break;
            }
        }
        // --- GESTION DES TOUCHES NORMALES (ZQSD, Espace, Echap) ---
        else {
            switch (touche) {
                // Quitter (Echap)
                case 27:
                    partieEnCours = 0;
                    break;

                // Mouvements (ZQSD)
                case 'z': case 'Z':
                    if (curseurY > 0) curseurY--;
                    break;
                case 's': case 'S':
                    if (curseurY < HAUTEUR_AFFICHEE - 1) curseurY++;
                    break;
                case 'q': case 'Q':
                    if (curseurX > 0) curseurX--;
                    break;
                case 'd': case 'D':
                    if (curseurX < LARGEUR_AFFICHEE - 1) curseurX++;
                    break;

                // Sélection (Espace)
                case ' ':
                    if (selectX == -1) {
                        selectX = curseurX;
                        selectY = curseurY;
                    } else {
                        if (estAdjacent(selectY, selectX, curseurY, curseurX)) {
                            permuterItems(partie, selectY, selectX, curseurY, curseurX);
                            // À FAIRE : logique de détection/gravité ici
                        } else {
                            allerA(0, HAUTEUR_AFFICHEE + 10);
                            afficherMessageTemporaire("Sélection invalide ! Échange non adjacent.");
                            getch();
                        }
                        selectX = -1;
                        selectY = -1;
                    }
                    break;
            } // fin switch (touches normales)
        } // fin else

        // --- Rafraîchissement de l'affichage ---
        if (partieEnCours) {
            // On rafraîchit l'écran APRÈS chaque action
            afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);
        }
    }
}
