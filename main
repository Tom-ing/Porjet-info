#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include "structures.h"
#include "affichage.h"
#include "moteur.h"
#include "sauvegarde.h"
#include <time.h>
#include <windows.h>

void jouerNiveau(Partie* partie);

int main() {
    Partie partie;
    int continuer = 1;

    system("chcp 65001 > nul");

    while (continuer) {
        afficherMenuPrincipal();

        char touche = getch();

        switch (touche) {
            case '1':
                afficherRegles();
                getch();
                break;

            case '2':
                initialiserPartie(&partie);
                jouerNiveau(&partie);
                break;

            case '3':
                effacerEcran();
                afficherMessageTemporaire("Chargement non implémenté pour cette démo");
                getch();
                break;

            case '4':
                continuer = 0;
                break;

            default:
                allerA(0, 30);
                afficherMessageTemporaire("Choix invalide !");
                getch();
                break;
        }
    }

    effacerEcran();
    changerCouleur(COULEUR_VERT);
    printf("\n\n    Merci d'avoir joué à ECE HEROES !\n\n");
    changerCouleur(COULEUR_RESET);

    return 0;
}

void jouerNiveau(Partie* partie) {
    int curseurX = 5;
    int curseurY = 5;
    int selectX = -1, selectY = -1;
    int partieEnCours = 1;
    unsigned char touche;

    //timer
    clock_t debutNiveau = clock();
    int tempsInitial = partie->temps_restant;
    int tempsAffiche = tempsInitial;

    // Affiche le jeu COMPLET une première fois
    afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);

    while (partieEnCours) {

        //gestion timer
        clock_t now = clock();
        double tempsPasse = ((double)(now - debutNiveau)) / CLOCKS_PER_SEC;
        partie->temps_restant = tempsInitial - (int)tempsPasse;
        if (partie->temps_restant < 0) partie->temps_restant = 0;

        int actionClavier = 0;

        // --- 2. GESTION DES ENTRÉES (NON-BLOQUANT) ---
        if (kbhit()) {
            touche = getch();
            actionClavier = 1; // rafraichissement

            if (touche == 224) {
                touche = getch();
                switch (touche) {
                    case 72: if (curseurY > 0) curseurY--; break;
                    case 80: if (curseurY < HAUTEUR - 1) curseurY++; break;
                    case 75: if (curseurX > 0) curseurX--; break;
                    case 77: if (curseurX < LARGEUR - 1) curseurX++; break;
                }
            }
            else {
                switch (touche) {
                    case 27: partieEnCours = 0; break;
                    case 'z': case 'Z': if (curseurY > 0) curseurY--; break;
                    case 's': case 'S': if (curseurY < HAUTEUR - 1) curseurY++; break;
                    case 'q': case 'Q': if (curseurX > 0) curseurX--; break;
                    case 'd': case 'D': if (curseurX < LARGEUR - 1) curseurX++; break;
                    case ' ':
                        if (selectX == -1) {
                            selectX = curseurX;
                            selectY = curseurY;
                        } else {
                            if (estAdjacent(selectY, selectX, curseurY, curseurX)) {
                                permuterItems(partie, selectY, selectX, curseurY, curseurX);
                                gererMatchsEtCascades(partie);
                            } else {
                                allerA(0, 35);
                                afficherMessageTemporaire("Sélection invalide ! Échange non adjacent.");
                                getch();
                            }
                            selectX = -1; selectY = -1;
                        }
                        break;
                } // fin switch
            } // fin else (touche normale)
        } // fin if (kbhit)

        // --- 3. VÉRIFICATION DE L'ÉTAT DU JEU ---
        int victoire = verifierVictoire(partie);

        if (victoire) {
            // Affiche l'écran final (avec le score à jour)
            if(!actionClavier) afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);
            afficherVictoire();
            getch();
            partieEnCours = 0;

        } else if (partie->coups_restants <= 0 || partie->temps_restant <= 0) {
            // Affiche l'écran final (avec le score à jour)
            if(!actionClavier) afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);

            partie->vies--;
            afficherDefaite();

            if (partie->temps_restant <= 0) {
                allerA(0, 35); afficherMessageTemporaire("Temps ecoule ! Vous perdez une vie.");
            } else {
                allerA(0, 35); afficherMessageTemporaire("Plus de coups ! Vous perdez une vie.");
            }
            getch();
            partieEnCours = 0;
        }

        // --- 4. RAFRAÎCHISSEMENT DE L'ÉCRAN ---

        // 4a. Rafraîchissement LÉGER (Timer)
        // Si le timer a changé ET qu'on n'a pas appuyé sur une touche
        if (partieEnCours && !actionClavier && partie->temps_restant != tempsAffiche) {
            tempsAffiche = partie->temps_restant;
            rafraichirTimerSeulement(partie); // Ne rafraîchit que le timer
        }

        // 4b. Rafraîchissement LOURD (Tout l'écran)
        // Si le joueur a appuyé sur une touche (ou fait un match)
        if (actionClavier && partieEnCours) {
            afficherNiveauJeu(partie, curseurX, curseurY, selectX, selectY);
        }

        Sleep(10); // Petite pause (50ms) pour ne pas saturer le CPU
    }
}
